name: üóëÔ∏è Manually Triggered Terraform Destroy

# This trigger allows the workflow to be run manually and accepts inputs.
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select the action to perform (must be "Terraform_destroy" to proceed)'
        required: true
        default: 'Terraform_plan'
        type: choice
        options:
          - Terraform_plan
          - Terraform_destroy
      resource:
        description: 'The subdirectory containing the Terraform code (e.g., "modules/s3")'
        required: true
        default: '.'
        type: string

jobs:
  terraform_destroy:
    name: "Terraform Destroy"
    
    # Run this job only if the input 'action' selected by the user is 'Terraform_destroy'.
    if: ${{ github.event.inputs.action == 'Terraform_destroy' }}
    
    runs-on: ubuntu-latest
    
    # Define AWS environment variables for the entire job
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
    # Set the working directory for all 'run' steps in this job based on user input.
    defaults:
      run:
        working-directory: ${{ github.event.inputs.resource }}
        
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4

      - name: Set Up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0 # Use a stable, recent version

      - name: Terraform Init
        run: terraform init
        
      # Plan the destroy first, outputting the changes
      - name: Terraform Destroy Plan
        run: terraform plan -destroy -out=destroy.tfplan

      # Execute the destroy operation using the generated plan
      - name: Terraform Destroy Apply
        run: terraform apply destroy.tfplan -auto-approve
